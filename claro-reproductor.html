<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <title>Claro TV - Reproductor</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
        }
        #player {
            width: 100%;
            height: 100vh;
        }
        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="player"></div>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Cargando stream...</p>
    </div>

    <!-- Incluir CryptoJS para desencriptación -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <!-- Incluir JWPlayer -->
    <script src="//ssl.p.jwpcdn.com/player/v/8.26.0/jwplayer.js"></script>
    <script>jwplayer.key = 'XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo';</script>

    <script>
        // Configuración de streams de claro.html
        let mt = "csc-axs-edge01.sensa.com.ar";

        const streams = {
            clarosports: {
                url: "https://"+mt+"/live/eds/ClaroSports/live_dash_cld/ClaroSports.mpd",
                key: "======wMklzY3IDZlJDZkRTMilDO4EWO3M2YwYzY4MmYkBzM0MTOldjNjVDMxcTNlBDZiRmNmFjN3MGOkBzMyQmMlFTYhFzMkNzY2Q2YilDNiVTZmJWZyUGM5ITM2MjZ0IGOykzYygjN4QjZ1gTZ3IGNwQTZxMzMlN2M3ITN4ETMkdjMxcTYkJmYmJ2YhJjY0gTYhlDNwgDZhBTZihDOkNDOxEDZ6ITNzYzY4UGOmljY1kDZ4YWYwIWY0YDZjV2N5MTYhVjNa1b2c3d4e5f67890"
            },
            telefe: {
                url: "https://"+mt+"/live/eds/Telefe/live_dash_cld/Telefe.mpd",
                key: "======QYxQmMxYDZmRGOjFDZ2QWNjhTO4kTM1IWY1QWZjZjZkhDN5ImNxIGNmNWYzIWOhlTYyUDMxIWO0UzY4MzYzIjYyUTY0QmZ0UGZwgzMxYGZiJjY5MmZzkTNxUGOxETNlhTY3QTZ5QGZ1gjZ2UmMkZmM5EWZ4MWY2QzNhZGMwczM3YmN1QWY3gzNxEWZ5UWYilDMzgDZmVTO1EDZxEDZkVmY6I2YxYTNyU2YwcjN4M2MyYjMwYDNjdTZyIWM2kjYzgjYa1b2c3d4e5f67890"
            },
            espn1: {
                url: "https://"+mt+"/live/eds/ESPN/live_dash_cld/ESPN.mpd",
                key: "======ANilDM5UTM2QjM1cTYzcDZ5ETZ1ImM3EWY0IDM3YWNiNTZ2EWN4MzN2QzMiVzNwYjNiFWZ4ADOhZDNhRmN3EzM5YzNyYWN0cjYxkDOjVGMxEjYkNWNwYDZ3MWNmJWYlRDMlBjY5QjNmVmYhZTYykTMwADNmNzYlVmZxQTOzQTYkJDZ2UGZ4MGNkJmM1EGMlV2NwcDNyIWZllDO4YTMmRjM6QmZzEjZlBTMyMWMiJTM2YDN0YGO4cDZxczY0UTOzcTMa1b2c3d4e5f67890"
            },
            espn2: {
                url: "https://"+mt+"/live/eds/ESPN2/live_dash_cld/ESPN2.mpd",
                key: "======AOyQGM5MjZ3MTYhhjYwgjNwATYlljMxETYkZzY5E2N1YzYzM2MxAjYzITNidjYyQDN3ImY1E2Y4IGMyYWMkJGOyEWM1IjYiJWNkRDZhhDM2gjM0QjMxYzY4E2MiNGN3IzYwUDN0AjYxMjMiZDZxIGN3gTYyIDM0EjMxYWMmhTM1MjMiF2MmdzY4EWO3QjZjJmZihTZ4M2YxQDN3kDMwAjZ6MTNhBTY3AjYzQWYkhjN2ETZykDZzcDMjRGNxYDZhJjNa1b2c3d4e5f67890"
            },
            espn3: {
                url: "https://"+mt+"/live/eds/ESPN3/live_dash_cld/ESPN3.mpd",
                key: "======gYjlDN1EjY4EDM4UDM4UWY3AjN2MWYzYTMyMDNhZGMlNGZ2kjYiZWYzgjMwkjZ3gTOjFWO4MWNzIWMzgTY0UDZxYmNzU2M5IGNmJWM4kjN1UzN5MGZjdTMlVTYzIzNmRjNjJWYxIWYlFGMzcTZxcDZjZDN0IjZyYGNyYDMyQ2N4MDOhNTN4UmN4MWZzUWM3YWZ5kTZ1cDNlVWZxgDN3MTZ6IWO4E2N5UGNygjNyITZlJWNwYWMzUjYlNTO2EGNhlTYa1b2c3d4e5f67890"
            },
            espn4: {
                url: "https://"+mt+"/live/eds/ESPN4/live_dash_cld/ESPN4.mpd",
                key: "======QY0MmM1gTM0UGZ4MWOzQTOzETZldTN0gTZhVmN4ADNkJDM0M2M5ADZ0UmYjhzN2EDNyMDN2ITYhBzNkFmZxUzMjVzM2kTMhNDM0QDOlFWZ4EmNzUDNmVTOwkTZ5ETM3YWMwAjZwIWZlJGMxIGZiNjY2MGO0gTZ0UzMhJmYxgzNxImN2IGMiNTO1YmNwEGNmJTO5UmYxQWZ3UzN0gDOzczY6Q2N3ITZ4MTM0QjM5EjM0IWZzMzMyYjY2EzYlFTYkZmMa1b2c3d4e5f67890"
            },
            foxsports1: {
                url: "https://"+mt+"/live/eds/FoxSports1/live_dash_cld/FoxSports1.mpd",
                key: "======gNjJjMjNTM0IWYlJzM0UWMihzM2kDMwcTZhFGZzQDMlFTYmljM5EzY2YzMhJWY1EWY1ETNzMmZxkzNhJTY4AzNhNGO1IzM0QTN3MGN1ImYklDZklTYjZGMjdTNwkTYlZzMiNGOyUWMlRWYzIzM3QTNlFWYiR2MzkzMjFDMmZGZxUjM4IDMhVDOxU2NxkTNhVjYkJDZ4UzN4IWO2ADMxIGN6cTN2EWNkZWZkFmNxEDN0E2N5Y2Y4UWOjVWZiVGOkJGMa1b2c3d4e5f67890"
            },
            foxsports2: {
                url: "https://"+mt+"/live/eds/FoxSports2/live_dash_cld/FoxSports2.mpd",
                key: "======wNxMWM5gTY3MWMwEzM3QjZlBTYhBDNzEjNwUGZxQGZ4IGNkV2MkZDOjljYjRDNxU2MiZDN3YjY3YTOhdTOjJjZ1IWMzEWO4UjNygzNwIWMxgTYwE2YiNzM1QGOjNjM0AjZ1EmZxcjM0YzM1kzN1MjZmNWY4UGO1EGMlNGNzkDMmJGOiZmYkZjZzQTM5ADZhhDMmNTMiVWZlRjMklTMiBTZ6Q2MlRWZyITOyYTNzMTM3EDN1QWMhRWNjZmNmFWZzAjMa1b2c3d4e5f67890"
            },
            foxsports3: {
                url: "https://"+mt+"/live/eds/FoxSports3/live_dash_cld/FoxSports3.mpd",
                key: "======QO0EmZ4QDOiNDN2MjM0EmZ5MDMhVTNwYTMiVjY2QDMhFTZhJTNkJ2YwUzM5ADMwATOwIWMiZTZ1EzY4UGZ2UzMjVTY4Y2YlZ2M4EWYklTZxAjN3UWMiVWOlhjM0UWOjRWMwETNjdzNmRjMyM2YwczMhhTYkJmM3MGZzMWO4kTN2EzN4EmY5ATMiZTOmZWN3gzY0EDOiNWM1cTYiNGOmFjM6MzYhF2NwEjN5Q2Y5QTYlNGN1cDNiNzN3MDNhRGN5MzNa1b2c3d4e5f67890"
            },
            tntsports: {
                url: "https://"+mt+"/live/eds/TNTSports/live_dash_cld/TNTSports.mpd",
                key: "======ANiR2M4UWNkRmMwUmZ5UjNkRDZxQmYxYWMzATMlBjYkVTOxkTMxczMwMmY3IzMkNDNkhTMwEzMkFjZkZGN1UjZ4QTO0MWN0M2YzEmNxEGOjZWZlV2MhRDM3QzN1ITOlNWMklDN0MDZ4gTO2YDOjRWY0cTY5ITNxczMyQDZjlTOxATNwgjZmBjN1IWZ5QzMyMmZlFWZwMTM1YjNmRDZhF2M6EWYygDM2QWNjNzYkRTZxI2N4UGZhR2YiFGMwQzN5YzMa1b2c3d4e5f67890"
            },
            tycsports: {
                url: "https://"+mt+"/live/eds/TYCSports/live_dash_cld/TYCSports.mpd",
                key: "======wYyYjNiZWN4YDNwYDZmJjY4EjNlBDNjhTN3kjNlVmYmJzM1UzNxQTN5ATN1QGZlZmM1EDZjF2YjNjZmZDZkBTNiFGMjRmZjZDOhJjNwkTN1QmYiZWNlZmN4gjMiNmNyMDM0gzYyMTMxQjNlNzYyYDNxkTZiFWZkRmNiNGOiBzNhdjYmhzM5UDOzYjNhVzYjZDMkZzM2EzYwUmY0QjNyETY6MDNhRWNhZmNjRWO3UTOjhDZ4QWOjhTZxIGMhJGZhZmNa1b2c3d4e5f67890"
            },
            deportv: {
                url: "https://"+mt+"/live/eds/Deportv/live_dash_cld/Deportv.mpd",
                key: "======QN4kzY2QjN2gDNhlTNyIjYlJDM1U2MkdDN1MmNjJjYwgjY4YDN4IDMkRTNxU2MhJTMxYWO5UWYhJjZjRTYkdTN3MmMjJTYwQ2MkFTM3YTZ1gDZhVWNhZGMzM2MmNTO0YmN0kjZmZDOkVzMzUzNyIDZhNWNkRTM2AzYjVmM0QmNhFzMjVDNmBTNlhDM5MWOyImNyYTM5QWYhFjN0EDN2UjN6ITNxEmY3YjYwMjYkBzN0ITMzMzN3YTN2gjZlJzNkhzNa1b2c3d4e5f67890"
            },
            tvpublica: {
                url: "https://"+mt+"/live/eds/TVPublica/live_dash_cld/TVPublica.mpd",
                key: "======AMkFTZwQDZkBTY2gTMzgDZxU2YmVmN1MmN1QjY3YzM0UDZjZ2MihjNwEDM3kDOhJzY5QjYxQWOzATM0YGOlNmYwYTZ5MzM5AzN1MTY4YWY1YjM3UzYyQGMkhTY3MTZ1MTOhFWO5MWYmVGMldDZyQDO1YWMkFTO0UTZyUWNxMWNxIGOxADNiZjYjhTOlNjN0gDOyUGN2kzNlZmMiBTNmJTZ6IzN2QTO1kDMjFGZ4QGO2gzM2ITOiZDNhVmMkdjMhVDZa1b2c3d4e5f67890"
            }
        };

        // Función para obtener parámetros de URL
        function getParameterByName(name) {
            name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                results = regex.exec(location.search);
            return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        }

        // Función para desencriptar claves
        function decryptAES(ciphertext, ivHex, key) {
            try {
                const keyHash = CryptoJS.SHA256(CryptoJS.enc.Utf8.parse(key));
                const iv = CryptoJS.enc.Hex.parse(ivHex);
                
                const decrypted = CryptoJS.AES.decrypt(
                    { ciphertext: CryptoJS.enc.Hex.parse(ciphertext) },
                    keyHash,
                    { 
                        iv: iv,
                        mode: CryptoJS.mode.CBC,
                        padding: CryptoJS.pad.Pkcs7
                    }
                );
                
                return decrypted.toString(CryptoJS.enc.Utf8);
            } catch (error) {
                console.error("[ERROR] en decryptAES:", error);
                return null;
            }
        }

        // Función para desofuscar claves
        function deobfuscateKey(obfuscatedKey) {
            try {
                const trimmedKey = obfuscatedKey.slice(4, -16);
                const reversedKey = trimmedKey.split("").reverse().join("");
                const decodedBytes = CryptoJS.enc.Base64.parse(reversedKey);
                const decodedText = decodedBytes.toString(CryptoJS.enc.Utf8);
                const [ivHex, ciphertext] = decodedText.split(':');
                if (!ivHex || !ciphertext) {
                    throw new Error("Formato inválido después de desofuscación");
                }
                const masterKey = "EnRjmF8X6VZlfS4PifbJD8oWK4PaHnlZ";
                const decrypted = decryptAES(ciphertext, ivHex, masterKey);
                
                if (!decrypted) {
                    throw new Error("Fallo en desencriptación AES");
                }
                
                return decrypted;
            } catch (error) {
                console.error("[ERROR] en deobfuscateKey:", error);
                return null;
            }
        }

        // Función para obtener stream por ID
        function getStreamById(streamId) {
            try {
                const stream = streams[streamId];
                if (!stream) throw new Error(`Stream ${streamId} no encontrado`);
                
                let finalKey = stream.key;
                if (finalKey.startsWith('====')) {
                    finalKey = deobfuscateKey(finalKey);
                    if (!finalKey) throw new Error("Fallo en desencriptación");
                }
                if (finalKey && finalKey.includes(':')) {
                    const [kid, key] = finalKey.split(':');
                    return {
                        url: stream.url,
                        key: { [kid.trim()]: key.trim() }
                    };
                }

                throw new Error("Formato de clave inválido");
            } catch (error) {
                console.error(`[ERROR] en getStreamById: ${error.message}`);
                return null;
            }
        }

        // Obtener parámetros de URL
        var getStream = getParameterByName('get');
        var autostart = getParameterByName('start') === 'true';
        var getLang = getParameterByName('lang');

        // Verificar si se proporcionó un stream
        if (!getStream) {
            document.getElementById('loading').innerHTML = '<div class="error-message"><h2>Error</h2><p>No se especificó un stream. Uso: ?get=espn1&start=true</p></div>';
        } else {
            // Obtener configuración del stream
            const streamConfig = getStreamById(getStream);
            
            if (!streamConfig) {
                document.getElementById('loading').innerHTML = '<div class="error-message"><h2>Error</h2><p>Stream no encontrado: ' + getStream + '</p><p>Streams disponibles: ' + Object.keys(streams).join(', ') + '</p></div>';
            } else {
                // Configurar JWPlayer
                const playerInstance = jwplayer("player");
                
                playerInstance.setup({
                    playlist: [{
                        "sources": [
                            {
                                "default": false,
                                "type": "dash",
                                "file": streamConfig.url,
                                "drm": {
                                    "clearkey": streamConfig.key
                                },
                                "label": "0"
                            }
                        ]
                    }],
                    width: "100%",
                    height: "100%",
                    aspectratio: "16:9",
                    autostart: autostart,
                    cast: {},
                    sharing: {}
                });

                // Ocultar loading cuando el player esté listo
                playerInstance.on('ready', function() {
                    document.getElementById('loading').style.display = 'none';
                });

                // Manejar errores
                playerInstance.on('error', function() {
                    document.getElementById('loading').innerHTML = '<div class="error-message"><h2>Error de Reproducción</h2><p>No se pudo cargar el stream: ' + getStream + '</p></div>';
                });

                // Manejar idioma si se especifica
                if (getLang) {
                    var selectedLanguage = parseInt(getLang);
                    var languageChangedDuringPlay = false;

                    playerInstance.on('play', function(e) {
                        if (!languageChangedDuringPlay) {
                            var currentLanguage = playerInstance.getCurrentAudioTrack();
                            if (currentLanguage !== selectedLanguage) {
                                playerInstance.setCurrentAudioTrack(selectedLanguage);
                                languageChangedDuringPlay = true;
                            }
                        }
                    });

                    playerInstance.on('complete', function(e) {
                        languageChangedDuringPlay = false;
                    });
                }
            }
        }
    </script>
</body>
</html>
